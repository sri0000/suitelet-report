/**
 * @NApiVersion 2.x
 * @NScriptType Suitelet
 */
define(["N/record", "N/render", "N/search", "N/runtime", "N/file", "N/format"], function (record, render, search, runtime, file, format) {
    function onRequest(context) {
        try {
            var rec_id = context.request.parameters.recordid;
            log.debug('rec_id', rec_id);
            if (!rec_id) {
                throw new Error("Record ID is missing from request parameters.");
            }

            // Load the invoice record using the rec_id
            var loadPO = record.load({
                type: 'customrecord_impal_wbt_sm_brch_rp',
                id: rec_id
            });

            var selectedBranch = loadPO.getValue({
                fieldId: 'custrecord_impal_brch'
            });
            log.debug("branch", selectedBranch);

            var selectedPeriod = loadPO.getText({
                fieldId: 'custrecord_impal_acc_pr'
            });
            log.debug("accountpr", selectedPeriod);

            var selectedPeriod1 = loadPO.getValue({
                fieldId: 'custrecord_impal_acc_pr'
            });

            if (selectedPeriod) {
                log.debug('if entered');
                var trimmedPeriod = selectedPeriod.trim();
                log.debug('trimmedPeriod', trimmedPeriod);
                var monthName = trimmedPeriod.split(' ')[6];  //["FY", "2024", ":", "Q1", "2024", ":", "May", "2023"]
                log.debug('monthName', monthName);
                var periodParts = selectedPeriod.trim().split(' ');
                log.debug('periodParts', periodParts);
                var monthNames = periodParts[6];
                log.debug('monthNames', monthNames);
                var year = parseInt(periodParts[7]);
                log.debug('year', year);

                var monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3,
                    'May': 4, 'Jun': 5, 'Jul': 6, 'Aug': 7,
                    'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };

                var monthNumber = monthMap[monthNames];
                var startDate = new Date(year, monthNumber, 1);
                log.debug("before formatting start date", startDate);
                var endDate = new Date(year, monthNumber + 1, 0);
                log.debug("before formatting end date", endDate);

                var formattedStartDate = format.format({
                    value: startDate,
                    type: format.Type.DATE
                });
                var formattedEndDate = format.format({
                    value: endDate,
                    type: format.Type.DATE
                });
                log.debug('Start Date:', formattedStartDate);
                log.debug('End Date:', formattedEndDate);

                log.debug('Trimmed Period:', trimmedPeriod);
                log.debug('Month Name:', monthName);
                log.debug('Year:', year);

                // Map month abbreviations to their corresponding fields
                var monthFieldMap = {
                    'Jan': 'custrecord_wbt_salesman_field_jan',
                    'Feb': 'custrecord_wbt_salesman_field_feb',
                    'Mar': 'custrecord_wbt_salesman_field_march',
                    'Apr': 'custrecord_wbt_salesman_field_april',
                    'May': 'custrecord_wbt_salesman_field_may',
                    'Jun': 'custrecord_wbt_salesman_field_june',
                    'Jul': 'custrecord_wbt_salesman_field_july',
                    'Aug': 'custrecord_wbt_salesman_field_august',
                    'Sep': 'custrecord_wbt_salesman_field_september',
                    'Oct': 'custrecord_wbt_salesman_field_october',
                    'Nov': 'custrecord_wbt_salesman_field_november',
                    'Dec': 'custrecord_wbt_salesman_field_december'
                };

                // Get today's date
                var today = format.format({
                    value: new Date(),
                    type: format.Type.DATE
                });// Initialize an object to store sales rep info
             // Initialize an object to store sales rep info
var salesRepInfo = {};

// Initialize a variable to store the total amount
var totalAmount = 0;

// First Search: Fetch all relevant sales reps dynamically based on branch and period
var salesRepSearch = search.create({
    type: "customrecord_impal_wbt_salesman",
    filters: [
        ["custrecord_wbt_salesman_branch", "anyof", selectedBranch], // assuming selectedBranch is passed in context
        "AND",
        ["custrecord_wbt_salesman_accounting_perio", "is", selectedPeriod1] // assuming selectedPeriod1 is passed in context
    ],
    columns: [
        search.createColumn({name: "internalid"}), // Sales rep internal ID
        search.createColumn({name: "custrecord_impal_sales_executive_m_s"}) // Sales executive ID
    ]
});

// Store each sales rep with a default amount of 0
salesRepSearch.run().each(function(result) {
    var salesRepId = result.getValue("custrecord_impal_sales_executive_m_s");
    var salesRepName = result.getText("custrecord_impal_sales_executive_m_s");

    log.debug('salesRepId', salesRepId);
    log.debug('salesRepName', salesRepName);

    // Add each sales rep to salesRepInfo with amount initialized to 0
    salesRepInfo[salesRepId] = {
        name: salesRepName,
        amount: 0
    };
    return true;
});

// Log the sales reps retrieved to verify
log.debug("Retrieved Sales Reps", salesRepInfo);

// Second search to get sales amounts for each rep
var invoiceSearch = search.create({
    type: "invoice",
    settings: [{"name": "consolidationtype", "value": "ACCTTYPE"}],
    filters: [
        ["type", "anyof", "CustInvc"], 
        "AND", 
        ["salesrep", "anyof", Object.keys(salesRepInfo)] // Use dynamically retrieved sales rep IDs
    ],
    columns: [
        search.createColumn({
            name: "salesrep",
            summary: "GROUP",
            label: "Sales Rep"
        }),
        search.createColumn({
            name: "amount",
            summary: "SUM",
            label: "Amount"
        })
    ]
});

// Update salesRepInfo with actual amounts from the invoice search
invoiceSearch.run().each(function(result) {
    var salesRepId = result.getValue({ name: "salesrep", summary: "GROUP" });
    var totalAmountForRep = result.getValue({ name: "amount", summary: "SUM" });
    totalAmountForRep = totalAmountForRep ? parseFloat(totalAmountForRep) : 0;

    if (salesRepInfo[salesRepId]) {
        salesRepInfo[salesRepId].amount = totalAmountForRep;
        totalAmount += totalAmountForRep; // Add to the total sum
    }
    return true;
});

// Now you have salesRepInfo and totalAmount ready to pass or return
log.debug("Sales Rep Information (with Amounts)", salesRepInfo);
log.debug("Total Amount Sum", totalAmount);

// Arrays to store sales rep names and amounts separately
var salesRepNames = [];
var salesRepAmounts = [];
var tr = ''; // Initialize the table row variable
var serialNumber = 1; // Initialize serial number
var td = ''; // Table data (TD) variable

// Loop through salesRepInfo to populate salesRepNames and salesRepAmounts arrays
for (var salesRepId in salesRepInfo) {
    if (salesRepInfo.hasOwnProperty(salesRepId)) {
        // Push name and amount to respective arrays
        salesRepNames.push(salesRepInfo[salesRepId].name);
        salesRepAmounts.push(salesRepInfo[salesRepId].amount);
    }
}

// Generate HTML table rows
for (var i = 0; i < salesRepNames.length; i++) {
    var salesRepName = salesRepNames[i];
    var salesRepAmount = salesRepAmounts[i];

    // Construct a new table row with individual cells (TD) for each sales rep
    td = '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">' + serialNumber + '</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">' + salesRepName + '</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;"></td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">&nbsp;</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">&nbsp;</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">&nbsp;</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">' + salesRepAmount + '</td>' +
         '<td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">&nbsp;</td>';

    // Append this new row to the table
    tr += '<tr>' + td + '</tr>';

    // Increment the serial number for the next row
    serialNumber++;
}

// Log or send the table rows and total amount as a response
log.debug("Generated Table Rows", tr);
log.debug("Total Sales Amount", totalAmount); // Display the total amount in logs

            }

            
    var xmlTemplateFile='<?xml version="1.0"?>\
<!DOCTYPE pdf PUBLIC "-//big.faceless.org//report" "report-1.1.dtd">\
<pdf>\
<head>\
</head>\
<body style="font-family: Arial, sans-serif; font-size: 11px; margin: 0; padding: 20px; width: 250mm; height: 297mm;">\
  <!-- First Table -->\
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">\
    <tr style="background-color: #f2f2f2;">\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold; font-style: normal; letter-spacing: normal; align: center; vertical-align: middle;">\WBT 4.2</td>\
       <td colspan="7" style="border: 1px solid #ddd; padding: 4px; font-weight: bold; font-style: normal; letter-spacing: normal; align: center; vertical-align: middle;">\WHITE BOARD TRACKER</td>\
       <td colspan="2" style="border: 1px solid #ddd; padding: 4px; font-weight: bold; font-style: normal; letter-spacing: normal;align: center; vertical-align: middle;">1-Apr-24</td>\
    </tr>\
    <tr style="background-color: #f2f2f2;">\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">\Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">\BRANCH NAME</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">\Working days for month</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: normal; font-style: normal; letter-spacing: normal; vertical-align: middle;">26</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">Standup meeting working day</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: normal; font-style: normal; letter-spacing: normal; vertical-align: middle;">1</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">\Completed working days</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: normal; font-style: normal; letter-spacing: normal; vertical-align: middle;">1</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; letter-spacing: normal; text-align: center; vertical-align: middle;">\Balance days for month</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: normal; font-style: normal; letter-spacing: normal; vertical-align: middle;">25</td>\
    </tr>\
  </table>\
  <!-- Second Table -->\
  <table style="width: 100%; border-collapse: collapse;">\
    <!-- Header Row -->\
    <tr style="background-color: #4CAF50; color: white;">\
      <td colspan="11" style="align:center;border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Sales</td>\
    </tr>\
    <!-- Sub-header Rows -->\
    <tr style="background-color: #f9f9f9;">\
      <td rowspan="2" style="border: 1px solid #ddd;background-color: #f2f2f2; padding: 4px; font-weight: bold; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\SI.No</td>\
      <td rowspan="2" style="border: 1px solid #ddd; background-color: #f2f2f2;padding: 4px; font-weight: bold; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\Sales Executive M/s</td>\
      <td colspan="4" style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; vertical-align: middle; letter-spacing: normal;">\Target Lacs</td>\
      <td colspan="3" style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; vertical-align: middle; letter-spacing: normal;">\Sales Lacs</td>\
      <td colspan="3" style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; vertical-align: middle; letter-spacing: normal;">\Cum % of Sales</td>\
    </tr>\
    <tr style="background-color: #f2f2f2;">\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\For the Month</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Avg/Day</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Cum Target till Date</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Sales Target for</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Sales for the Day</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Cumulative Sales</td>\
      <td style="border: 1px solid #ddd; padding:4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Sales +/-</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Sales vs Target</td>\
      <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; font-style: normal; letter-spacing: normal; vertical-align: middle;">\Cus Salesmen Share</td>\
    </tr>\
    <!-- Rows with Date Values -->\
    <tr>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">\Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">1-Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">4-Aug-23</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">1-Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">1-Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">1-Apr-24</td>\
      <td style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal; text-align: center; vertical-align: middle; letter-spacing: normal;">4-Apr-23</td>\
    </tr>\
    <!-- items map -->\
     '+tr+'\
    <!-- total map -->\
        <tr>\
      <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
      <td  style="border: 1px solid #ddd; padding: 4px; font-weight: bold; font-style: normal;align: center; vertical-align: middle; letter-spacing: normal;">\Total</td>\
        <td  style="border: 1px solid #ddd; padding:4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">'+totalAmount+'</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        <td  style="border: 1px solid #ddd; padding: 4px; font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
    </tr>\
  </table>\
<table style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 11px;top:1%;">\
  <tr>\
    <td colspan="3" style="font-weight: bold; background-color: #f2f2f2; padding: 8px;align: center; border: 1px solid #ddd;font-weight: bold; font-style: normal;vertical-align: middle; letter-spacing: normal;">\NEW DEALERS` SALES - TARGET 6% OF SALES</td>\
  </tr>\
  <tr>\
    <td style="width: 50%;">\
      <table style="width: 100%; border-collapse: collapse; ">\
        <tr>\
          <td colspan="4" style="background-color: #4CAF50; color: white;  padding: 8px;align: center;font-weight: bold; font-style: normal;vertical-align: middle; letter-spacing: normal;">\
          </td>\
        </tr>\
        <tr>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: bold; font-style: normal; vertical-align: middle; letter-spacing: normal;">\Target 6% of sales for the day</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: bold; font-style: normal;vertical-align: middle; letter-spacing: normal;">\New Dealers` Sales for the day</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: bold; font-style: normal;vertical-align: middle; letter-spacing: normal;">\Cumulative New Dealer Sales</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: bold; font-style: normal; vertical-align: middle; letter-spacing: normal;">\% sales achieved Vs target</td>\
        </tr>\
        <tr>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: normal; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\</td>\
        </tr>\
      </table>\
    </td>\
    <td style="width: 10%;">\</td>\ <!-- Empty column for spacing -->\
    <td style="width: 50%;">\
      <table style="width: 100%; border-collapse: collapse;">\
        <tr>\
          <td colspan="4" style="background-color: #4CAF50; color: white; font-weight: bold; padding: 8px;align: center;font-weight: bold; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\CUM. NEW DEALERS ` SALES REPORT - Lacs for this month (till this month)</td>\
        </tr>\
        <tr>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: bold; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\Cum.Branch Sales till last month</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: bold; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\New Dealers` Sales Target</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: bold; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\New Dealer Sales</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;font-weight: bold; font-style: normal;text-align: center; vertical-align: middle; letter-spacing: normal;">\% sales achieved Vs target</td>\
        </tr>\
        <tr>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px; align: center;">\</td>\
          <td style="border: 1px solid #ddd; padding: 6px;align: center;">\</td>\
        </tr>\
      </table>\
    </td>\
  </tr>\
</table>\
</body>\
</pdf>';

  // Create and configure the renderer
  var renderer = render.create();
  renderer.templateContent = xmlTemplateFile;
  // Log renderer object for debugging
  log.debug({
    title: "Renderer Object",
    details: renderer,
  });

  // Add record to renderer
  renderer.addRecord("record", loadPO);
  // Render PDF
  var invoicePdf = renderer.renderAsPdf();

  // Send the PDF as response
  context.response.writeFile({
    file: invoicePdf,
    isInline: true,
  });
  
        
}catch(error) {
  log.error({
    title: "Error in Suitelet",
    details: error.message,
  });

  // Send error response to the user
  context.response.write({
    output: "An error occurred: " + error.message,
  });
  
 
}

}
return {
    onRequest: onRequest
    };
  });

